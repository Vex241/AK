-- Miyavi-AK: Muscle Legends Kill All + POPULAR Server Hop + Auto Tiny Island
-- PlaceId: 3623096087
-- Features: PERSISTENT Kill Counter (reads from leaderstats)

local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")
local VirtualUser = game:GetService("VirtualUser")

-- Configuration (12-17 players to avoid full servers)
_G.placeId = 3623096087
_G.serverHopDelay = 40 -- 40 seconds
_G.minPlayers = 12 -- MINIMUM players to join
_G.maxPlayers = 17 -- MAXIMUM players to join (avoid full)
_G.killAllEnabled = true
_G.whitelistedPlayers = {"indieuns_fan"}
_G.autoPunchEnabled = true -- ENABLED BY DEFAULT
_G.fastPunchEnabled = true -- ENABLED BY DEFAULT
_G.punchSpamRate = 3
_G.autoTeleportTinyIsland = true -- ENABLED BY DEFAULT

-- NEW: Persistent kill tracking
_G.totalKills = 0 -- Will be loaded from file

-- JamJam Server Hop Variables
local AllIDs = {}
local foundAnything = ""
local actualHour = os.date("!*t").hour

-- Load saved data
pcall(function()
    AllIDs = HttpService:JSONDecode(readfile("NotSameServers.json"))
    _G.totalKills = HttpService:JSONDecode(readfile("total_kills.json")) or 0
end)

if #AllIDs == 0 then
    table.insert(AllIDs, actualHour)
    writefile("NotSameServers.json", HttpService:JSONEncode(AllIDs))
end

-- Save kills function
local function saveKills()
    pcall(function()
        writefile("total_kills.json", HttpService:JSONEncode(_G.totalKills))
    end)
end

-- Enhanced UserId spoof
local originalIndex
originalIndex = hookfunction(getrawmetatable(LocalPlayer).__index, newcclosure(function(self, key)
    if key == "UserId" then
        return 2412582721
    end
    return originalIndex(self, key)
end))

-- Wait for character
local function getCharacter()
    local char = LocalPlayer.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then
        char = LocalPlayer.CharacterAdded:Wait()
        char:WaitForChild("HumanoidRootPart")
    end
    return char
end

-- Teleport to Tiny Island
local function teleportToTinyIsland()
    task.spawn(function()
        wait(0.5) -- Wait for character to fully load
        local character = LocalPlayer.Character
        if not character then return end
        
        local hrp = character:FindFirstChild("HumanoidRootPart")
        if hrp then
            hrp.CFrame = CFrame.new(-37.1, 9.2, 1919)
            print("âœ… Teleported to Tiny Island")
        end
    end)
end

-- MODIFIED: Joins POPULAR servers only (12-17 players)
local function TPReturner()
    local Site
    if foundAnything == "" then
        Site = HttpService:JSONDecode(game:HttpGet('https://games.roblox.com/v1/games/' .. _G.placeId .. '/servers/Public?sortOrder=Desc&limit=100'))
    else
        Site = HttpService:JSONDecode(game:HttpGet('https://games.roblox.com/v1/games/' .. _G.placeId .. '/servers/Public?sortOrder=Desc&limit=100&cursor=' .. foundAnything))
    end

    local ID = ""
    if Site.nextPageCursor and Site.nextPageCursor ~= "null" and Site.nextPageCursor ~= nil then
        foundAnything = Site.nextPageCursor
    end

    local num = 0
    local validServers = {}
    
    -- PRIORITIZE popular servers in 12-17 range (AVOIDS FULL SERVERS)
    for i, v in pairs(Site.data) do
        local Possible = true
        ID = tostring(v.id)
        local playerCount = tonumber(v.playing)
        
        -- Only consider servers with 12-17 players (NOT full)
        if playerCount >= _G.minPlayers and playerCount <= _G.maxPlayers and tonumber(v.maxPlayers) > playerCount then
            -- Check if we haven't visited this server
            for _, Existing in pairs(AllIDs) do
                if num ~= 0 then
                    if ID == tostring(Existing) then
                        Possible = false
                        break
                    end
                else
                    if tonumber(actualHour) ~= tonumber(Existing) then
                        pcall(function()
                            delfile("NotSameServers.json")
                            AllIDs = {}
                            table.insert(AllIDs, actualHour)
                        end)
                    end
                end
                num = num + 1
            end
            if Possible == true then
                table.insert(validServers, {id = ID, playing = playerCount})
            end
        end
    end
    
    -- Join the MOST POPULAR server from valid list
    if #validServers > 0 then
        table.sort(validServers, function(a, b) return a.playing > b.playing end)
        local targetServer = validServers[1] -- Server with MOST players
        
        table.insert(AllIDs, targetServer.id)
        writefile("NotSameServers.json", HttpService:JSONEncode(AllIDs))
        
        print("âœ… Joining POPULAR server with " .. targetServer.playing .. " players!")
        TeleportService:TeleportToPlaceInstance(_G.placeId, targetServer.id, LocalPlayer)
        wait(4)
        return true
    end
    
    return false
end

local function serverHop()
    print("ğŸ”„ Searching for POPULAR server (" .. _G.minPlayers .. "-" .. _G.maxPlayers .. " players)...")
    local success = TPReturner()
    if not success then
        -- If no popular servers found, try again with next page
        if foundAnything ~= "" then
            TPReturner()
        else
            warn("âš ï¸ No popular servers found, retrying...")
            wait(5)
            serverHop()
        end
    end
end

-- Start server hop countdown
local function startServerHop()
    task.spawn(function()
        while true do
            for i = _G.serverHopDelay, 1, -1 do
                if timerLabel then
                    timerLabel.Text = string.format("Hop: %ds", i)
                end
                task.wait(1)
            end
            if statusLabel then
                statusLabel.Text = "ğŸš€ SERVER HOPPING TO POPULAR SERVER!"
            end
            serverHop()
            task.wait(5)
        end
    end)
end

-- Whitelist check
function isWhitelisted(target)
    local targetName = typeof(target) == "Instance" and target:IsA("Player") and target.Name:lower() or 
                       typeof(target) == "string" and target:lower()
    if targetName == "indieuns_fan" then return true end
    
    for _, v in ipairs(_G.whitelistedPlayers) do
        if v:lower() == targetName then
            return true
        end
    end
    return false
end

-- Check if player is alive
local function isAlive(p)
    return p and p.Character and p.Character:FindFirstChild("HumanoidRootPart") and p.Character:FindFirstChild("Humanoid") and p.Character.Humanoid.Health > 0
end

-- Equip punch tool
local function equipPunch()
    local backpack = LocalPlayer:WaitForChild("Backpack")
    local character = getCharacter()
    local humanoid = character:WaitForChild("Humanoid")
    
    local punch = backpack:FindFirstChild("Punch")
    if punch then
        humanoid:EquipTool(punch)
        return true
    end
    return false
end

-- Kill function with auto/fast punch
local function killPlayer(target)
    if not isAlive(target) then return end
    
    local character = getCharacter()
    if not character or not character:FindFirstChild("LeftHand") then return end
    
    pcall(function()
        -- MuscleEvent method (most reliable)
        local muscleEvent = LocalPlayer:FindFirstChild("muscleEvent")
        if muscleEvent then
            muscleEvent:FireServer("punch", "leftHand")
            muscleEvent:FireServer("punch", "rightHand")
        end
        
        -- Auto punch: ensure equipped
        if _G.autoPunchEnabled then
            equipPunch()
        end
        
        -- Fast punch: spam multiple times
        if _G.fastPunchEnabled then
            for i = 1, _G.punchSpamRate do
                firetouchinterest(target.Character.HumanoidRootPart, character.LeftHand, 0)
                firetouchinterest(target.Character.HumanoidRootPart, character.LeftHand, 1)
                task.wait(0.01)
            end
        else
            firetouchinterest(target.Character.HumanoidRootPart, character.LeftHand, 0)
            firetouchinterest(target.Character.HumanoidRootPart, character.LeftHand, 1)
        end
        
        -- Re-equip if needed
        if _G.autoPunchEnabled then
            equipPunch()
        end
    end)
end

-- UI Setup
local Library = loadstring(game:HttpGet("https://raw.githubusercontent.com/ISPPs54/Ui/refs/heads/main/eeee", true))()
local Window = Library:AddWindow("Miyavi-AK Popular Hop", {
    main_color = Color3.fromRGB(255, 0, 0),
    min_size = Vector2.new(350, 320),
    can_resize = false
})

local MainTab = Window:AddTab("Main")
MainTab:AddLabel("KILL ALL (POPULAR HOP)").TextSize = 24

local statusLabel = MainTab:AddLabel("Status: Loading...")
local timerLabel = MainTab:AddLabel(string.format("Hop: %ds", _G.serverHopDelay))

-- Kill All toggle (starts ON)
MainTab:AddSwitch("Kill All Players", function(state)
    _G.killAllEnabled = state
    statusLabel.Text = "âœ… Kill All: " .. (state and "ON" or "OFF")
end):Set(true)

-- Auto Punch toggle (starts ON)
local autoPunchToggle = MainTab:AddSwitch("Auto Punch", function(enabled)
    _G.autoPunchEnabled = enabled
    statusLabel.Text = "âœ… Auto Punch: " .. (enabled and "ON" or "OFF")
end, true)

-- Fast Punch toggle (starts ON)
local fastPunchToggle = MainTab:AddSwitch("Fast Punch", function(enabled)
    _G.fastPunchEnabled = enabled
    statusLabel.Text = "âœ… Fast Punch: " .. (enabled and "ON" or "OFF")
end, true)

-- Auto Tiny Island toggle (starts ON)
local autoTinyToggle = MainTab:AddSwitch("Auto Tiny Island", function(enabled)
    _G.autoTeleportTinyIsland = enabled
    statusLabel.Text = "âœ… Auto Tiny Island: " .. (enabled and "ON" or "OFF")
end, true)

-- Server settings
MainTab:AddLabel("Server Settings").TextSize = 20

-- Min Players setting (1-17)
MainTab:AddTextBox("Min Players (1-17)", function(text)
    local num = tonumber(text)
    if num and num >= 1 and num <= 17 then
        _G.minPlayers = math.floor(num)
        statusLabel.Text = "âœ… Min Players: " .. _G.minPlayers
    else
        statusLabel.Text = "âš ï¸ Enter number between 1-17"
    end
end, {placeholder = "12"})

-- Whitelist management
MainTab:AddLabel("Whitelist").TextSize = 20
local whitelistLabel = MainTab:AddLabel("Whitelisted: indieuns_fan")

MainTab:AddTextBox("Add Player", function(text)
    if text and text ~= "" then
        table.insert(_G.whitelistedPlayers, text:lower())
        whitelistLabel.Text = "Whitelisted: " .. table.concat(_G.whitelistedPlayers, ", ")
    end
end)

MainTab:AddButton("Clear Whitelist", function()
    _G.whitelistedPlayers = {"indieuns_fan"}
    whitelistLabel.Text = "Whitelisted: indieuns_fan"
end)

-- NEW: KC (KILL COUNT) Tab that auto-shows
local KillCountTab = Window:AddTab("KC (KILL COUNT)")
KillCountTab:Show() -- Auto-show this tab on load

-- Kill Count Display (large and prominent)
KillCountTab:AddLabel("").TextSize = 10
KillCountTab:AddLabel("ğŸ’€ TOTAL KILLS ğŸ’€").TextSize = 28
KillCountTab:AddLabel("").TextSize = 5
local killCountLabel = KillCountTab:AddLabel(tostring(_G.totalKills))
killCountLabel.TextSize = 48 -- HUGE FONT
killCountLabel.TextColor3 = Color3.fromRGB(255, 0, 0)

-- NEW: Function to get real kill count from leaderstats
local function getRealKillCount()
    local leaderstats = LocalPlayer:FindFirstChild("leaderstats")
    if leaderstats then
        local kills = leaderstats:FindFirstChild("Kills")
        if kills then
            return kills.Value
        end
    end
    return 0
end

-- NEW: Update kill count display
local function updateKillCount()
    local realKills = getRealKillCount()
    _G.totalKills = realKills
    saveKills()
    if killCountLabel then
        killCountLabel.Text = tostring(_G.totalKills)
    end
end

-- NEW: Monitor kill count continuously
task.spawn(function()
    while true do
        wait(1) -- Update every second
        updateKillCount()
    end
end)

KillCountTab:AddLabel("").TextSize = 10
KillCountTab:AddLabel("Kills across all servers").TextSize = 16
KillCountTab:AddLabel("").TextSize = 20

-- Initialize
task.spawn(function()
    wait(1) -- Wait for UI to load
    getCharacter()
    equipPunch()
    updateKillCount() -- Load initial kill count
    if _G.autoTeleportTinyIsland then
        teleportToTinyIsland()
    end
    statusLabel.Text = "âœ… Status: Killing All"
end)

-- Main kill loop
_G.killConnection = RunService.Heartbeat:Connect(function()
    if _G.killAllEnabled then
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= LocalPlayer and not isWhitelisted(player) then
                killPlayer(player)
            end
        end
    end
end)

-- Handle character respawn
LocalPlayer.CharacterAdded:Connect(function()
    wait(0.5)
    equipPunch()
    -- Auto teleport to Tiny Island on respawn
    if _G.autoTeleportTinyIsland then
        teleportToTinyIsland()
    end
    statusLabel.Text = "âœ… Status: Killing All (Respawned)"
end)

-- Start server hop
startServerHop()

-- Anti-AFK
LocalPlayer.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
end)

print("âœ… Miyavi-AK Popular Hop + Kill Counter Loaded")
print("ğŸ¯ Kill All: ACTIVE (kills everyone except indieuns_fan)")
print("ğŸ‘Š Auto Punch: ENABLED BY DEFAULT")
print("âš¡ Fast Punch: ENABLED BY DEFAULT")
print("ğŸï¸ Auto Tiny Island: ENABLED BY DEFAULT")
print("ğŸ’€ Kill Counter: READS FROM LEADERSTATS")
print("â±ï¸ Server Hop: " .. _G.serverHopDelay .. " seconds")
print("ğŸ”¥ SERVER RANGE: " .. _G.minPlayers .. "-" .. _G.maxPlayers .. " players")
